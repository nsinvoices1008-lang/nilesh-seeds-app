<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§®‡§ø‡§≤‡•á‡§∂ ‡§∏‡•Ä‡§°‡•ç‡§∏ - Agriculture Retail App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Language Selector */
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .language-selector button {
            padding: 8px 16px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .language-selector button.active {
            background: white;
            color: #25D366;
        }

        /* Login/Register Screen */
        .auth-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            margin: 50px auto;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .logo h1 {
            color: #25D366;
            font-size: 32px;
            margin-bottom: 5px;
        }

        .tagline {
            color: #667781;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #000;
            font-weight: 600;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E9EDEF;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #25D366;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .error, .success {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            display: none;
        }

        .error {
            background: #ffebee;
            color: #c62828;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .error.show, .success.show {
            display: block;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #25D366;
            color: white;
        }

        .btn-primary:hover {
            background: #128C7E;
        }

        .btn-secondary {
            background: #E9EDEF;
            color: #000;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #667781;
        }

        .auth-switch a {
            color: #25D366;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        /* Dashboard */
        .dashboard {
            background: #ECE5DD;
            min-height: 100vh;
            width: 100%;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header h1 {
            font-size: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: white;
            color: #25D366;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }

        .dashboard-content {
            padding: 20px;
            padding-bottom: 80px;
        }

        /* Search Bar */
        .search-bar {
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #E9EDEF;
            border-radius: 25px;
            font-size: 16px;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #25D366;
        }

        /* Chat Interface */
        .chat-view {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            background: #25D366;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: white;
            color: #25D366;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Farmer List (Admin) */
        .farmer-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .farmer-item {
            padding: 15px 20px;
            border-bottom: 1px solid #E9EDEF;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .farmer-item:hover {
            background: #f5f5f5;
        }

        .farmer-item.active {
            background: #DCF8C6;
        }

        .farmer-info {
            flex: 1;
        }

        .farmer-name {
            font-weight: 600;
            color: #000;
            margin-bottom: 5px;
        }

        .farmer-details {
            font-size: 12px;
            color: #667781;
        }

        .farmer-actions {
            display: flex;
            gap: 5px;
        }

        /* Weather Widget */
        .weather-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
        }

        .weather-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .weather-icon {
            font-size: 48px;
        }

        .weather-temp {
            font-size: 36px;
            font-weight: 700;
        }

        .weather-details {
            text-align: right;
        }

        .weather-location {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
        }

        /* Messages */
        .messages-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #ECE5DD;
        }

        .message {
            display: flex;
            margin-bottom: 10px;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 8px;
        }

        .message.sent .message-content {
            background: #DCF8C6;
        }

        .message.received .message-content {
            background: white;
        }

        .message-content p {
            margin: 0 0 5px 0;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 11px;
            color: #667781;
        }

        .message-input-form {
            display: flex;
            padding: 10px;
            background: white;
            border-top: 1px solid #E9EDEF;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #E9EDEF;
            border-radius: 25px;
            font-size: 15px;
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border: none;
            background: #25D366;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        /* Video Call Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a1a;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #2a2a2a;
            border-radius: 10px 10px 0 0;
            color: white;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            min-height: 400px;
            position: relative;
        }

        #localVideo, #remoteVideo {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
        }

        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 100px;
            border: 2px solid white;
        }

        .call-placeholder {
            text-align: center;
            color: #888;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 0 0 10px 10px;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #444;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #555;
        }

        .control-btn.active {
            background: #25D366;
        }

        .control-btn.end-call {
            background: #dc3545;
        }

        .control-btn.end-call:hover {
            background: #c82333;
        }

        /* Map Container */
        .map-container {
            width: 100%;
            height: 400px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #25D366;
        }

        .card h3 {
            margin: 15px 0 10px 0;
            color: #000;
        }

        /* Profile Photo Upload */
        .profile-photo-upload {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-photo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: #E9EDEF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            overflow: hidden;
        }

        .profile-photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Ledger Link */
        .ledger-link {
            background: #E7F3FF;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ledger-link input {
            flex: 1;
            padding: 8px;
            border: 1px solid #E9EDEF;
            border-radius: 5px;
            margin-right: 10px;
        }

        .ledger-link button {
            padding: 8px 16px;
            background: #25D366;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .bottom-nav button {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: #667781;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .bottom-nav button.active {
            color: #25D366;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-card {
                padding: 20px;
                margin: 20px;
            }

            .dashboard-header h1 {
                font-size: 16px;
            }

            .user-info span {
                display: none;
            }

            .modal-content {
                width: 95%;
            }

            #localVideo {
                width: 100px;
                height: 75px;
            }
        }

        /* Loading Spinner */
        .loading {
            text-align: center;
            padding: 20px;
            color: #667781;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25D366;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="language-selector">
        <button onclick="changeLanguage('hindi')" class="active" id="langHindi">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
        <button onclick="changeLanguage('english')" id="langEnglish">English</button>
        <button onclick="changeLanguage('marathi')" id="langMarathi">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
    </div>

    <!-- Login Screen -->
    <div class="screen active" id="loginScreen">
        <div class="container">
            <div class="auth-card">
                <div class="logo">
                    <div class="logo-icon">üåæ</div>
                    <h1>‡§®‡§ø‡§≤‡•á‡§∂ ‡§∏‡•Ä‡§°‡•ç‡§∏</h1>
                    <p class="tagline" id="tagline">‡§Ü‡§™‡§ï‡•á ‡§ñ‡•á‡§§‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§•‡•Ä</p>
                </div>
                
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label id="usernameLabel">‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ</label>
                        <input type="text" id="loginUsername" placeholder="‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" required>
                    </div>
                    
                    <div class="form-group">
                        <label id="passwordLabel">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                        <input type="password" id="loginPassword" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" required>
                    </div>
                    
                    <div class="error" id="loginError"></div>
                    
                    <button type="submit" class="btn btn-primary" id="loginBtn">‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç</button>
                </form>
                
                <div class="auth-switch">
                    <span id="noAccountText">‡§ñ‡§æ‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à?</span>
                    <a onclick="showRegister()" id="registerLink">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Screen -->
    <div class="screen" id="registerScreen">
        <div class="container">
            <div class="auth-card">
                <div class="logo">
                    <div class="logo-icon">üåæ</div>
                    <h1>‡§®‡§ø‡§≤‡•á‡§∂ ‡§∏‡•Ä‡§°‡•ç‡§∏</h1>
                    <p class="tagline">‡§®‡§Ø‡§æ ‡§ï‡§ø‡§∏‡§æ‡§® ‡§™‡§Ç‡§ú‡•Ä‡§ï‡§∞‡§£</p>
                </div>
                
                <form onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label>‡§®‡§æ‡§Æ *</label>
                        <input type="text" id="regName" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" required>
                    </div>

                    <div class="form-group">
                        <label>‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ *</label>
                        <input type="text" id="regUsername" placeholder="‡§Ø‡•Ç‡§®‡§ø‡§ï ‡§Ø‡•Ç‡§ú‡§∞‡§®‡•á‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç" required>
                    </div>
                    
                    <div class="form-group">
                        <label>‡§ó‡§æ‡§Å‡§µ *</label>
                        <input type="text" id="regVillage" placeholder="‡§ó‡§æ‡§Å‡§µ ‡§ï‡§æ ‡§®‡§æ‡§Æ" required>
                    </div>
                    
                    <div class="form-group">
                        <label>‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞ *</label>
                        <input type="tel" id="regPhone" placeholder="10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§®‡§Ç‡§¨‡§∞" pattern="[0-9]{10}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>‡§™‡§§‡§æ *</label>
                        <textarea id="regAddress" placeholder="‡§™‡•Ç‡§∞‡§æ ‡§™‡§§‡§æ" required></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° *</label>
                        <input type="password" id="regPassword" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§®‡§æ‡§è‡§Ç" required>
                    </div>

                    <div class="form-group">
                        <label>‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç *</label>
                        <input type="password" id="regConfirmPassword" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" required>
                    </div>
                    
                    <div class="error" id="registerError"></div>
                    <div class="success" id="registerSuccess"></div>
                    
                    <button type="submit" class="btn btn-primary">‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
                    <button type="button" class="btn btn-secondary" onclick="showLogin()">‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="screen" id="dashboard">
        <div class="dashboard-header">
            <h1 id="dashboardTitle">üåæ ‡§®‡§ø‡§≤‡•á‡§∂ ‡§∏‡•Ä‡§°‡•ç‡§∏</h1>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <span id="currentUser"></span>
                <button class="logout-btn" onclick="handleLogout()" id="logoutBtn">‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
            </div>
        </div>

        <div class="dashboard-content">
            <!-- Chat Tab -->
            <div class="tab-content active" id="chatTab">
                <!-- Admin: Farmer List with Search -->
                <div id="adminChatView" style="display: none;">
                    <div class="search-bar">
                        <input type="text" id="farmerSearch" placeholder="üîç ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="searchFarmers()">
                    </div>
                    <div class="farmer-list" id="farmerList"></div>
                </div>

                <!-- Chat Interface -->
                <div class="chat-view" id="chatInterface" style="display: none;">
                    <div class="chat-header">
                        <div>
                            <h2 id="chatTitle">‡§ö‡•à‡§ü</h2>
                            <small id="chatSubtitle"></small>
                        </div>
                        <div class="chat-actions">
                            <button class="icon-btn" onclick="initiateVoiceCall()" title="Voice Call">üìû</button>
                            <button class="icon-btn" onclick="initiateVideoCall()" title="Video Call">üìπ</button>
                            <button class="icon-btn" onclick="closeChatInterface()" title="Close" style="display: none;" id="closeChatBtn">‚úï</button>
                        </div>
                    </div>
                    
                    <div id="weatherWidgetContainer"></div>
                    
                    <div class="messages-container" id="messagesContainer"></div>
                    
                    <form class="message-input-form" onsubmit="sendMessage(event)">
                        <input type="text" class="message-input" id="messageInput" placeholder="‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡§ø‡§ñ‡•á‡§Ç...">
                        <button type="submit" class="send-btn">üì§</button>
                    </form>
                </div>
            </div>

            <!-- Locations Tab (Admin Only) -->
            <div class="tab-content" id="locationsTab">
                <div class="card">
                    <h2>üìç ‡§ï‡§ø‡§∏‡§æ‡§®‡•ã‡§Ç ‡§ï‡•á ‡§∏‡•ç‡§•‡§æ‡§®</h2>
                    <div class="search-bar">
                        <input type="text" id="locationSearch" placeholder="üîç ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç..." oninput="searchLocations()">
                    </div>
                    <div id="locationsList"></div>
                </div>
            </div>

            <!-- Ledger Tab -->
            <div class="tab-content" id="ledgerTab">
                <div class="card">
                    <h2>üìä ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§π‡•Ä</h2>
                    <div id="ledgerContent"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settingsTab">
                <div class="card">
                    <h2>‚öôÔ∏è ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h2>
                    <div id="settingsContent"></div>
                </div>
            </div>
        </div>

        <nav class="bottom-nav" id="bottomNav"></nav>
    </div>

    <!-- Video/Voice Call Modal -->
    <div class="modal" id="callModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="callTitle">‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡•â‡§≤</h3>
                <button class="close-btn" onclick="endCall()">‚úï</button>
            </div>
            <div class="video-container" id="videoContainer">
                <div class="call-placeholder" id="callPlaceholder">
                    <p>üìπ ‡§ï‡•â‡§≤ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>
                </div>
                <video id="remoteVideo" autoplay playsinline style="display: none;"></video>
                <video id="localVideo" autoplay playsinline muted style="display: none;"></video>
            </div>
            <div class="call-controls">
                <button class="control-btn" id="muteBtn" onclick="toggleMute()" title="Mute">üé§</button>
                <button class="control-btn" id="videoBtn" onclick="toggleVideo()" title="Video">üìπ</button>
                <button class="control-btn end-call" onclick="endCall()" title="End Call">üìû</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentLanguage = 'hindi';
        let currentUser = null;
        let farmers = JSON.parse(localStorage.getItem('farmers')) || [];
        let messages = JSON.parse(localStorage.getItem('messages')) || {};
        let activeChatFarmer = null;
        let localStream = null;
        let remoteStream = null;
        let isMuted = false;
        let isVideoOff = false;
        let watchId = null;

        // Translations
        const translations = {
            hindi: {
                tagline: '‡§Ü‡§™‡§ï‡•á ‡§ñ‡•á‡§§‡•Ä ‡§ï‡•á ‡§∏‡§æ‡§•‡•Ä',
                username: '‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ',
                password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
                login: '‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç',
                logout: '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
                noAccount: '‡§ñ‡§æ‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à?',
                register: '‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡§∞ ‡§ï‡§∞‡•á‡§Ç',
                chat: '‡§ö‡•à‡§ü',
                locations: '‡§∏‡•ç‡§•‡§æ‡§®',
                ledger: '‡§ñ‡§æ‡§§‡§æ ‡§¨‡§π‡•Ä',
                settings: '‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏',
                videoCall: '‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§ï‡•â‡§≤',
                voiceCall: '‡§µ‡•â‡§á‡§∏ ‡§ï‡•â‡§≤',
                weather: '‡§Æ‡•å‡§∏‡§Æ',
                humidity: '‡§®‡§Æ‡•Ä',
                windSpeed: '‡§π‡§µ‡§æ ‡§ï‡•Ä ‡§ó‡§§‡§ø',
                searchFarmer: '‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ñ‡•ã‡§ú‡•á‡§Ç',
                noFarmers: '‡§ï‡•ã‡§à ‡§ï‡§ø‡§∏‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ',
                profile: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
                editProfile: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç',
                changePassword: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç',
                language: '‡§≠‡§æ‡§∑‡§æ',
                save: '‡§∏‡§π‡•á‡§ú‡•á‡§Ç',
                cancel: '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
                ledgerLink: '‡§ñ‡§æ‡§§‡§æ ‡§¨‡§π‡•Ä ‡§≤‡§ø‡§Ç‡§ï',
                assignLink: '‡§≤‡§ø‡§Ç‡§ï ‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç',
                copyLink: '‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç',
                viewLocation: '‡§∏‡•ç‡§•‡§æ‡§® ‡§¶‡•á‡§ñ‡•á‡§Ç',
                lastSeen: '‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§¨‡§æ‡§∞ ‡§¶‡•á‡§ñ‡§æ',
                online: '‡§ë‡§®‡§≤‡§æ‡§á‡§®',
                offline: '‡§ë‡§´‡§≤‡§æ‡§á‡§®'
            },
            english: {
                tagline: 'Your Farming Partner',
                username: 'Username',
                password: 'Password',
                login: 'Login',
                logout: 'Logout',
                noAccount: 'No account?',
                register: 'Register',
                chat: 'Chat',
                locations: 'Locations',
                ledger: 'Ledger',
                settings: 'Settings',
                videoCall: 'Video Call',
                voiceCall: 'Voice Call',
                weather: 'Weather',
                humidity: 'Humidity',
                windSpeed: 'Wind Speed',
                searchFarmer: 'Search farmer name',
                noFarmers: 'No farmers found',
                profile: 'Profile',
                editProfile: 'Edit Profile',
                changePassword: 'Change Password',
                language: 'Language',
                save: 'Save',
                cancel: 'Cancel',
                ledgerLink: 'Ledger Link',
                assignLink: 'Assign Link',
                copyLink: 'Copy Link',
                viewLocation: 'View Location',
                lastSeen: 'Last Seen',
                online: 'Online',
                offline: 'Offline'
            },
            marathi: {
                tagline: '‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∂‡•á‡§§‡•Ä ‡§∏‡§æ‡§•‡•Ä',
                username: '‡§µ‡§æ‡§™‡§∞‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§µ',
                password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
                login: '‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§æ',
                logout: '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
                noAccount: '‡§ñ‡§æ‡§§‡•á ‡§®‡§æ‡§π‡•Ä?',
                register: '‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§ï‡§∞‡§æ',
                chat: '‡§ö‡•Ö‡§ü',
                locations: '‡§∏‡•ç‡§•‡§æ‡§®‡•á',
                ledger: '‡§ñ‡§æ‡§§‡•á‡§µ‡§π‡•Ä',
                settings: '‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§ú',
                videoCall: '‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§ï‡•â‡§≤',
                voiceCall: '‡§µ‡•ç‡§π‡•â‡§á‡§∏ ‡§ï‡•â‡§≤',
                weather: '‡§π‡§µ‡§æ‡§Æ‡§æ‡§®',
                humidity: '‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ',
                windSpeed: '‡§µ‡§æ‡§±‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§µ‡•á‡§ó',
                searchFarmer: '‡§∂‡•á‡§§‡§ï‡§±‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ ‡§∂‡•ã‡§ß‡§æ',
                noFarmers: '‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§∏‡§æ‡§™‡§°‡§≤‡•á ‡§®‡§æ‡§π‡•Ä‡§§',
                profile: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤',
                editProfile: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§æ',
                changePassword: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡§æ',
                language: '‡§≠‡§æ‡§∑‡§æ',
                save: '‡§ú‡§§‡§® ‡§ï‡§∞‡§æ',
                cancel: '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ',
                ledgerLink: '‡§ñ‡§æ‡§§‡•á‡§µ‡§π‡•Ä ‡§≤‡§ø‡§Ç‡§ï',
                assignLink: '‡§≤‡§ø‡§Ç‡§ï ‡§®‡§ø‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ï‡§∞‡§æ',
                copyLink: '‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§æ',
                viewLocation: '‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡§π‡§æ',
                lastSeen: '‡§∂‡•á‡§µ‡§ü‡§ö‡•á ‡§™‡§æ‡§π‡§ø‡§≤‡•á',
                online: '‡§ë‡§®‡§≤‡§æ‡§á‡§®',
                offline: '‡§ë‡§´‡§≤‡§æ‡§á‡§®'
            }
        };

        // Initialize
        window.onload = function() {
            const savedLang = localStorage.getItem('language');
            if (savedLang) changeLanguage(savedLang);
            
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                requestPermissions();
            }
        };

        // Request Permissions
        function requestPermissions() {
            // Request location permission
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentUser.location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            timestamp: new Date().toISOString()
                        };
                        
                        // Start watching location for real-time updates
                        watchId = navigator.geolocation.watchPosition(
                            (pos) => {
                                currentUser.location = {
                                    latitude: pos.coords.latitude,
                                    longitude: pos.coords.longitude,
                                    timestamp: new Date().toISOString()
                                };
                                updateFarmerLocation();
                            },
                            (error) => console.log('Location error:', error),
                            { enableHighAccuracy: true, maximumAge: 10000 }
                        );
                        
                        updateFarmerLocation();
                        showDashboard();
                    },
                    (error) => {
                        alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§™‡§∞‡§Æ‡§ø‡§∂‡§® ‡§¶‡•á‡§Ç‡•§ ‡§Ø‡§π ‡§ê‡§™ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡•§');
                        showDashboard();
                    }
                );
            }
        }

        // Update farmer location in database
        function updateFarmerLocation() {
            if (currentUser && currentUser.role === 'farmer' && currentUser.location) {
                const farmerIndex = farmers.findIndex(f => f.username === currentUser.username);
                if (farmerIndex !== -1) {
                    farmers[farmerIndex].location = currentUser.location;
                    farmers[farmerIndex].lastSeen = new Date().toISOString();
                    localStorage.setItem('farmers', JSON.stringify(farmers));
                }
            }
        }

        // Get real-time weather
        async function getWeather(lat, lon) {
            try {
                // Using OpenWeatherMap API (you'll need to add your API key)
                const apiKey = 'YOUR_API_KEY'; // Replace with actual API key
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`);
                const data = await response.json();
                
                return {
                    temperature: Math.round(data.main.temp),
                    humidity: data.main.humidity,
                    windSpeed: Math.round(data.wind.speed * 3.6),
                    condition: data.weather[0].description,
                    icon: getWeatherIcon(data.weather[0].main),
                    location: data.name
                };
            } catch (error) {
                // Fallback to simulated data
                return {
                    temperature: 28,
                    humidity: 65,
                    windSpeed: 12,
                    condition: 'Partly Cloudy',
                    icon: '‚õÖ',
                    location: 'Current Location'
                };
            }
        }

        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '‚òÄÔ∏è',
                'Clouds': '‚òÅÔ∏è',
                'Rain': 'üåßÔ∏è',
                'Drizzle': 'üå¶Ô∏è',
                'Thunderstorm': '‚õàÔ∏è',
                'Snow': '‚ùÑÔ∏è',
                'Mist': 'üå´Ô∏è'
            };
            return icons[condition] || '‚õÖ';
        }

        // Display weather widget
        async function displayWeather() {
            if (currentUser && currentUser.location) {
                const weather = await getWeather(currentUser.location.latitude, currentUser.location.longitude);
                const t = translations[currentLanguage];
                
                const weatherHTML = `
                    <div class="weather-widget">
                        <h3>üå§Ô∏è ${t.weather}</h3>
                        <div class="weather-content">
                            <div class="weather-main">
                                <span class="weather-icon">${weather.icon}</span>
                                <span class="weather-temp">${weather.temperature}¬∞C</span>
                            </div>
                            <div class="weather-details">
                                <div>üíß ${t.humidity}: ${weather.humidity}%</div>
                                <div>üí® ${t.windSpeed}: ${weather.windSpeed} km/h</div>
                            </div>
                        </div>
                        <div class="weather-location">üìç ${weather.location}</div>
                    </div>
                `;
                
                document.getElementById('weatherWidgetContainer').innerHTML = weatherHTML;
            }
        }

        // Language Change
        function changeLanguage(lang) {
            currentLanguage = lang;
            const t = translations[lang];
            
            // Update UI elements
            document.getElementById('tagline').textContent = t.tagline;
            document.getElementById('usernameLabel').textContent = t.username;
            document.getElementById('passwordLabel').textContent = t.password;
            document.getElementById('loginBtn').textContent = t.login;
            document.getElementById('noAccountText').textContent = t.noAccount;
            document.getElementById('registerLink').textContent = t.register;
            document.getElementById('logoutBtn').textContent = t.logout;
            
            document.querySelectorAll('.language-selector button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('lang' + lang.charAt(0).toUpperCase() + lang.slice(1)).classList.add('active');
            
            localStorage.setItem('language', lang);
            
            if (currentUser) {
                setupNavigation();
                if (currentUser.role === 'farmer') {
                    displayWeather();
                }
            }
        }

        // Show Register
        function showRegister() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('registerScreen').classList.add('active');
        }

        // Show Login
        function showLogin() {
            document.getElementById('registerScreen').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');
        }

        // Handle Registration
        function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('regName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const village = document.getElementById('regVillage').value.trim();
            const phone = document.getElementById('regPhone').value.trim();
            const address = document.getElementById('regAddress').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            const errorEl = document.getElementById('registerError');
            const successEl = document.getElementById('registerSuccess');
            
            errorEl.classList.remove('show');
            successEl.classList.remove('show');
            
            // Validation
            if (password !== confirmPassword) {
                errorEl.textContent = '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç';
                errorEl.classList.add('show');
                return;
            }
            
            // Check if username already exists
            if (farmers.some(f => f.username === username)) {
                errorEl.textContent = '‡§Ø‡§π ‡§Ø‡•Ç‡§ú‡§∞‡§®‡•á‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à';
                errorEl.classList.add('show');
                return;
            }
            
            // Create new farmer
            const newFarmer = {
                name,
                username,
                village,
                phone,
                address,
                password,
                role: 'farmer',
                registeredAt: new Date().toISOString(),
                ledgerLink: '',
                profilePhoto: '',
                deviceId: generateDeviceId()
            };
            
            farmers.push(newFarmer);
            localStorage.setItem('farmers', JSON.stringify(farmers));
            
            successEl.textContent = '‡§∞‡§ú‡§ø‡§∏‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§∏‡§´‡§≤! ‡§Ö‡§¨ ‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡•á‡§Ç‡•§';
            successEl.classList.add('show');
            
            // Clear form
            document.getElementById('regName').value = '';
            document.getElementById('regUsername').value = '';
            document.getElementById('regVillage').value = '';
            document.getElementById('regPhone').value = '';
            document.getElementById('regAddress').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regConfirmPassword').value = '';
            
            setTimeout(() => showLogin(), 2000);
        }

        // Generate Device ID
        function generateDeviceId() {
            return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Handle Login
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            errorEl.classList.remove('show');
            
            // Admin login
            if (username === 'Nilesh Seeds' && password === '1008') {
                currentUser = {
                    username,
                    role: 'admin',
                    name: 'Nilesh Seeds'
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard();
                return;
            }
            
            // Farmer login
            const farmer = farmers.find(f => f.username === username && f.password === password);
            if (farmer) {
                currentUser = { ...farmer };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                requestPermissions();
                return;
            }
            
            errorEl.textContent = '‡§ó‡§≤‡§§ ‡§Ø‡•Ç‡§ú‡§∞‡§®‡•á‡§Æ ‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°';
            errorEl.classList.add('show');
        }

        // Show Dashboard
        function showDashboard() {
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('registerScreen').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            
            document.getElementById('currentUser').textContent = currentUser.name || currentUser.username;
            
            if (currentUser.profilePhoto) {
                document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.profilePhoto}" style="width:100%;height:100%;border-radius:50%;">`;
            }
            
            setupNavigation();
            
            if (currentUser.role === 'admin') {
                loadFarmerList();
            } else {
                // Farmer view - show chat with admin
                document.getElementById('chatInterface').style.display = 'block';
                document.getElementById('chatTitle').textContent = '‡§®‡§ø‡§≤‡•á‡§∂ ‡§∏‡•Ä‡§°‡•ç‡§∏';
                document.getElementById('chatSubtitle').textContent = 'Admin';
                activeChatFarmer = 'admin';
                loadMessages();
                displayWeather();
            }
        }

        // Setup Navigation
        function setupNavigation() {
            const t = translations[currentLanguage];
            const nav = document.getElementById('bottomNav');
            
            if (currentUser.role === 'farmer') {
                nav.innerHTML = `
                    <button onclick="switchTab('chat')" class="active">üí¨<br/>${t.chat}</button>
                    <button onclick="switchTab('ledger')">üìä<br/>${t.ledger}</button>
                    <button onclick="switchTab('settings')">‚öôÔ∏è<br/>${t.settings}</button>
                `;
            } else {
                nav.innerHTML = `
                    <button onclick="switchTab('chat')" class="active">üí¨<br/>${t.chat}</button>
                    <button onclick="switchTab('locations')">üìç<br/>${t.locations}</button>
                    <button onclick="switchTab('ledger')">üìä<br/>${t.ledger}</button>
                    <button onclick="switchTab('settings')">‚öôÔ∏è<br/>${t.settings}</button>
                `;
            }
            
            // Load initial tab content
            if (currentUser.role === 'admin') {
                loadAdminChatView();
            }
            loadLedgerContent();
            loadSettingsContent();
        }

        // Switch Tab
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            document.querySelectorAll('.bottom-nav button').forEach(btn => btn.classList.remove('active'));
            event.target.closest('button').classList.add('active');
            
            if (tab === 'locations' && currentUser.role === 'admin') {
                loadLocations();
            }
        }

        // Load Farmer List (Admin)
        function loadFarmerList() {
            const farmerListEl = document.getElementById('farmerList');
            const t = translations[currentLanguage];
            
            if (farmers.length === 0) {
                farmerListEl.innerHTML = `<div class="farmer-item"><p>${t.noFarmers}</p></div>`;
                return;
            }
            
            farmerListEl.innerHTML = farmers.map(farmer => `
                <div class="farmer-item" onclick="selectFarmer('${farmer.username}')">
                    <div class="farmer-info">
                        <div class="farmer-name">${farmer.name}</div>
                        <div class="farmer-details">üìû ${farmer.phone} | üèòÔ∏è ${farmer.village}</div>
                    </div>
                    <div class="farmer-actions">
                        <button class="icon-btn" onclick="event.stopPropagation(); editFarmerProfile('${farmer.username}')" title="Edit">‚úèÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Load Admin Chat View
        function loadAdminChatView() {
            document.getElementById('adminChatView').style.display = 'block';
            loadFarmerList();
        }

        // Search Farmers
        function searchFarmers() {
            const query = document.getElementById('farmerSearch').value.toLowerCase();
            const filtered = farmers.filter(f => 
                f.name.toLowerCase().includes(query) || 
                f.username.toLowerCase().includes(query) ||
                f.village.toLowerCase().includes(query)
            );
            
            const farmerListEl = document.getElementById('farmerList');
            const t = translations[currentLanguage];
            
            if (filtered.length === 0) {
                farmerListEl.innerHTML = `<div class="farmer-item"><p>${t.noFarmers}</p></div>`;
                return;
            }
            
            farmerListEl.innerHTML = filtered.map(farmer => `
                <div class="farmer-item" onclick="selectFarmer('${farmer.username}')">
                    <div class="farmer-info">
                        <div class="farmer-name">${farmer.name}</div>
                        <div class="farmer-details">üìû ${farmer.phone} | üèòÔ∏è ${farmer.village}</div>
                    </div>
                    <div class="farmer-actions">
                        <button class="icon-btn" onclick="event.stopPropagation(); editFarmerProfile('${farmer.username}')" title="Edit">‚úèÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Select Farmer (Admin)
        function selectFarmer(username) {
            activeChatFarmer = username;
            const farmer = farmers.find(f => f.username === username);
            
            document.getElementById('chatInterface').style.display = 'block';
            document.getElementById('closeChatBtn').style.display = 'block';
            document.getElementById('chatTitle').textContent = farmer.name;
            document.getElementById('chatSubtitle').textContent = `üìû ${farmer.phone}`;
            
            loadMessages();
        }

        // Close Chat Interface
        function closeChatInterface() {
            document.getElementById('chatInterface').style.display = 'none';
            document.getElementById('closeChatBtn').style.display = 'none';
            activeChatFarmer = null;
        }

        // Load Messages
        function loadMessages() {
            const chatKey = currentUser.role === 'admin' 
                ? `admin_${activeChatFarmer}` 
                : `admin_${currentUser.username}`;
            
            const chatMessages = messages[chatKey] || [];
            const container = document.getElementById('messagesContainer');
            
            container.innerHTML = chatMessages.map(msg => `
                <div class="message ${msg.sender === currentUser.username ? 'sent' : 'received'}">
                    <div class="message-content">
                        <p>${msg.text}</p>
                        <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString('hi-IN', { hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        // Send Message
        function sendMessage(event) {
            event.preventDefault();
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const chatKey = currentUser.role === 'admin' 
                ? `admin_${activeChatFarmer}` 
                : `admin_${currentUser.username}`;
            
            if (!messages[chatKey]) {
                messages[chatKey] = [];
            }
            
            const message = {
                sender: currentUser.username,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            messages[chatKey].push(message);
            localStorage.setItem('messages', JSON.stringify(messages));
            
            input.value = '';
            loadMessages();
        }

        // Initiate Video Call
        async function initiateVideoCall() {
            if (!activeChatFarmer) {
                alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç');
                return;
            }
            
            document.getElementById('callModal').classList.add('active');
            document.getElementById('callTitle').textContent = translations[currentLanguage].videoCall;
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').style.display = 'block';
                document.getElementById('callPlaceholder').style.display = 'none';
            } catch (error) {
                alert('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ø‡§æ ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§æ');
                endCall();
            }
        }

        // Initiate Voice Call
        async function initiateVoiceCall() {
            if (!activeChatFarmer) {
                alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡§ø‡§∏‡§æ‡§® ‡§ï‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç');
                return;
            }
            
            document.getElementById('callModal').classList.add('active');
            document.getElementById('callTitle').textContent = translations[currentLanguage].voiceCall;
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
                document.getElementById('callPlaceholder').innerHTML = '<p>üìû ‡§µ‡•â‡§á‡§∏ ‡§ï‡•â‡§≤ ‡§ö‡§≤ ‡§∞‡§π‡•Ä ‡§π‡•à...</p>';
            } catch (error) {
                alert('‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡•ã‡§® ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤ ‡§∏‡§ï‡§æ');
                endCall();
            }
        }

        // Toggle Mute
        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;
                    document.getElementById('muteBtn').classList.toggle('active', !isMuted);
                }
            }
        }

        // Toggle Video
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoOff = !videoTrack.enabled;
                    document.getElementById('videoBtn').classList.toggle('active', !isVideoOff);
                }
            }
        }

        // End Call
        function endCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('callModal').classList.remove('active');
            document.getElementById('localVideo').style.display = 'none';
            document.getElementById('remoteVideo').style.display = 'none';
            document.getElementById('callPlaceholder').style.display = 'block';
            document.getElementById('callPlaceholder').innerHTML = '<p>üìπ ‡§ï‡•â‡§≤ ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...</p>';
            
            isMuted = false;
            isVideoOff = false;
        }

        // Load Locations (Admin)
        function loadLocations() {
            const locationsEl = document.getElementById('locationsList');
            const farmersWithLocation = farmers.filter(f => f.location);
            
            if (farmersWithLocation.length === 0) {
                locationsEl.innerHTML = '<p>‡§ï‡•ã‡§à ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</p>';
                return;
            }
            
            locationsEl.innerHTML = farmersWithLocation.map(farmer => `
                <div class="card">
                    <h3>${farmer.name}</h3>
                    <p>üìû ${farmer.phone}</p>
                    <p>üèòÔ∏è ${farmer.village}</p>
                    <p>üìç Lat: ${farmer.location.latitude.toFixed(6)}, Lng: ${farmer.location.longitude.toFixed(6)}</p>
                    <p>üïê ${new Date(farmer.location.timestamp).toLocaleString('hi-IN')}</p>
                    <button class="btn btn-primary" onclick="viewOnMap(${farmer.location.latitude}, ${farmer.location.longitude}, '${farmer.name}')">
                        üó∫Ô∏è Google Maps ‡§™‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç
                    </button>
                </div>
            `).join('');
        }

        // Search Locations
        function searchLocations() {
            const query = document.getElementById('locationSearch').value.toLowerCase();
            const filtered = farmers.filter(f => 
                f.location && (
                    f.name.toLowerCase().includes(query) || 
                    f.username.toLowerCase().includes(query) ||
                    f.village.toLowerCase().includes(query)
                )
            );
            
            const locationsEl = document.getElementById('locationsList');
            
            if (filtered.length === 0) {
                locationsEl.innerHTML = '<p>‡§ï‡•ã‡§à ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä</p>';
                return;
            }
            
            locationsEl.innerHTML = filtered.map(farmer => `
                <div class="card">
                    <h3>${farmer.name}</h3>
                    <p>üìû ${farmer.phone}</p>
                    <p>üèòÔ∏è ${farmer.village}</p>
                    <p>üìç Lat: ${farmer.location.latitude.toFixed(6)}, Lng: ${farmer.location.longitude.toFixed(6)}</p>
                    <p>üïê ${new Date(farmer.location.timestamp).toLocaleString('hi-IN')}</p>
                    <button class="btn btn-primary" onclick="viewOnMap(${farmer.location.latitude}, ${farmer.location.longitude}, '${farmer.name}')">
                        üó∫Ô∏è Google Maps ‡§™‡§∞ ‡§¶‡•á‡§ñ‡•á‡§Ç
                    </button>
                </div>
            `).join('');
        }

        // View on Map
        function viewOnMap(lat, lng, name) {
            const url = `https://www.google.com/maps?q=${lat},${lng}&z=15&t=m`;
            window.open(url, '_blank');
        }

        // Load Ledger Content
        function loadLedgerContent() {
            const ledgerEl = document.getElementById('ledgerContent');
            const t = translations[currentLanguage];
            
            if (currentUser.role === 'farmer') {
                // Farmer's personal ledger link
                const farmer = farmers.find(f => f.username === currentUser.username);
                const ledgerLink = farmer?.ledgerLink || '';
                
                ledgerEl.innerHTML = `
                    <h3>‡§Ü‡§™‡§ï‡§æ ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§π‡•Ä ‡§≤‡§ø‡§Ç‡§ï</h3>
                    ${ledgerLink ? `
                        <div class="ledger-link">
                            <input type="text" value="${ledgerLink}" readonly>
                            <button onclick="copyLedgerLink('${ledgerLink}')">üìã ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
                        </div>
                        <button class="btn btn-primary" onclick="window.open('${ledgerLink}', '_blank')">
                            üîó ‡§≤‡§ø‡§Ç‡§ï ‡§ñ‡•ã‡§≤‡•á‡§Ç
                        </button>
                    ` : '<p>‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§≤‡§ø‡§Ç‡§ï ‡§Ö‡§∏‡§æ‡§á‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à</p>'}
                `;
            } else {
                // Admin: Assign links to farmers
                ledgerEl.innerHTML = `
                    <h3>‡§ï‡§ø‡§∏‡§æ‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡§æ‡§§‡§æ ‡§¨‡§π‡•Ä ‡§≤‡§ø‡§Ç‡§ï</h3>
                    ${farmers.map(farmer => `
                        <div class="card">
                            <h4>${farmer.name}</h4>
                            <p>üìû ${farmer.phone}</p>
                            <div class="ledger-link">
                                <input type="text" id="link_${farmer.username}" value="${farmer.ledgerLink || ''}" placeholder="‡§≤‡§ø‡§Ç‡§ï ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç">
                                <button onclick="assignLedgerLink('${farmer.username}')">üíæ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                            </div>
                        </div>
                    `).join('')}
                `;
            }
        }

        // Assign Ledger Link
        function assignLedgerLink(username) {
            const link = document.getElementById(`link_${username}`).value.trim();
            const farmerIndex = farmers.findIndex(f => f.username === username);
            
            if (farmerIndex !== -1) {
                farmers[farmerIndex].ledgerLink = link;
                localStorage.setItem('farmers', JSON.stringify(farmers));
                alert('‡§≤‡§ø‡§Ç‡§ï ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§∏‡§π‡•á‡§ú‡§æ ‡§ó‡§Ø‡§æ');
            }
        }

        // Copy Ledger Link
        function copyLedgerLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ');
            });
        }

        // Load Settings Content
        function loadSettingsContent() {
            const settingsEl = document.getElementById('settingsContent');
            const t = translations[currentLanguage];
            
            if (currentUser.role === 'farmer') {
                const farmer = farmers.find(f => f.username === currentUser.username);
                
                settingsEl.innerHTML = `
                    <h3>‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®</h3>
                    <div class="profile-photo-upload">
                        <div class="profile-photo-preview" id="profilePreview">
                            ${farmer.profilePhoto ? `<img src="${farmer.profilePhoto}">` : 'üë§'}
                        </div>
                        <input type="file" id="profilePhotoInput" accept="image/*" onchange="uploadProfilePhoto()" style="display:none;">
                        <button class="btn btn-secondary" onclick="document.getElementById('profilePhotoInput').click()">
                            üì∑ ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>‡§®‡§æ‡§Æ</label>
                        <input type="text" id="settingsName" value="${farmer.name}">
                    </div>
                    
                    <div class="form-group">
                        <label>‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ</label>
                        <input type="text" id="settingsUsername" value="${farmer.username}">
                    </div>
                    
                    <div class="form-group">
                        <label>‡§ó‡§æ‡§Å‡§µ</label>
                        <input type="text" id="settingsVillage" value="${farmer.village}">
                    </div>
                    
                    <div class="form-group">
                        <label>‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label>
                        <input type="tel" id="settingsPhone" value="${farmer.phone}">
                    </div>
                    
                    <div class="form-group">
                        <label>‡§™‡§§‡§æ</label>
                        <textarea id="settingsAddress">${farmer.address}</textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveProfile()">üíæ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                    
                    <h3 style="margin-top: 30px;">‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç</h3>
                    <div class="form-group">
                        <label>‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°</label>
                        <input type="password" id="newPassword">
                    </div>
                    <div class="form-group">
                        <label>‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§ï‡§∞‡•á‡§Ç</label>
                        <input type="password" id="confirmPassword">
                    </div>
                    <button class="btn btn-secondary" onclick="changePassword()">üîí ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¨‡§¶‡§≤‡•á‡§Ç</button>
                    
                    <h3 style="margin-top: 30px;">${t.language}</h3>
                    <button class="btn ${currentLanguage === 'hindi' ? 'btn-primary' : 'btn-secondary'}" onclick="changeLanguage('hindi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
                    <button class="btn ${currentLanguage === 'english' ? 'btn-primary' : 'btn-secondary'}" onclick="changeLanguage('english')">English</button>
                    <button class="btn ${currentLanguage === 'marathi' ? 'btn-primary' : 'btn-secondary'}" onclick="changeLanguage('marathi')">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
                `;
            } else {
                settingsEl.innerHTML = `
                    <h3>${t.language}</h3>
                    <button class="btn ${currentLanguage === 'hindi' ? 'btn-primary' : 'btn-secondary'}" onclick="changeLanguage('hindi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
                    <button class="btn ${currentLanguage === 'english' ? 'btn-primary' : 'btn-secondary'}" onclick="changeLanguage('english')">English</button>
                    <button class="btn ${currentLanguage === 'marathi' ? 'btn-primary' : 'btn-secondary'}" onclick="changeLanguage('marathi')">‡§Æ‡§∞‡§æ‡§†‡•Ä</button>
                `;
            }
        }

        // Upload Profile Photo
        function uploadProfilePhoto() {
            const file = document.getElementById('profilePhotoInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = e.target.result;
                    document.getElementById('profilePreview').innerHTML = `<img src="${photoData}">`;
                    
                    // Save to current user
                    currentUser.profilePhoto = photoData;
                    
                    // Update in farmers array
                    const farmerIndex = farmers.findIndex(f => f.username === currentUser.username);
                    if (farmerIndex !== -1) {
                        farmers[farmerIndex].profilePhoto = photoData;
                        localStorage.setItem('farmers', JSON.stringify(farmers));
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // Save Profile
        function saveProfile() {
            const name = document.getElementById('settingsName').value.trim();
            const username = document.getElementById('settingsUsername').value.trim();
            const village = document.getElementById('settingsVillage').value.trim();
            const phone = document.getElementById('settingsPhone').value.trim();
            const address = document.getElementById('settingsAddress').value.trim();
            
            // Check username availability
            if (username !== currentUser.username) {
                if (farmers.some(f => f.username === username)) {
                    alert('‡§Ø‡§π ‡§Ø‡•Ç‡§ú‡§∞‡§®‡•á‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à');
                    return;
                }
            }
            
            const farmerIndex = farmers.findIndex(f => f.username === currentUser.username);
            if (farmerIndex !== -1) {
                farmers[farmerIndex].name = name;
                farmers[farmerIndex].username = username;
                farmers[farmerIndex].village = village;
                farmers[farmerIndex].phone = phone;
                farmers[farmerIndex].address = address;
                
                localStorage.setItem('farmers', JSON.stringify(farmers));
                
                currentUser.name = name;
                currentUser.username = username;
                currentUser.village = village;
                currentUser.phone = phone;
                currentUser.address = address;
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                alert('‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à');
                document.getElementById('currentUser').textContent = name;
            }
        }

        // Change Password
        function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç');
                return;
            }
            
            const farmerIndex = farmers.findIndex(f => f.username === currentUser.username);
            if (farmerIndex !== -1) {
                farmers[farmerIndex].password = newPassword;
                localStorage.setItem('farmers', JSON.stringify(farmers));
                
                currentUser.password = newPassword;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                alert('‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§¶‡§≤ ‡§ó‡§Ø‡§æ');
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            }
        }

        // Edit Farmer Profile (Admin)
        function editFarmerProfile(username) {
            const farmer = farmers.find(f => f.username === username);
            if (!farmer) return;
            
            const settingsEl = document.getElementById('settingsContent');
            
            settingsEl.innerHTML = `
                <h3>${farmer.name} ‡§ï‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</h3>
                
                <div class="form-group">
                    <label>‡§®‡§æ‡§Æ</label>
                    <input type="text" id="editName" value="${farmer.name}">
                </div>
                
                <div class="form-group">
                    <label>‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ</label>
                    <input type="text" id="editUsername" value="${farmer.username}">
                </div>
                
                <div class="form-group">
                    <label>‡§ó‡§æ‡§Å‡§µ</label>
                    <input type="text" id="editVillage" value="${farmer.village}">
                </div>
                
                <div class="form-group">
                    <label>‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞</label>
                    <input type="tel" id="editPhone" value="${farmer.phone}">
                </div>
                
                <div class="form-group">
                    <label>‡§™‡§§‡§æ</label>
                    <textarea id="editAddress">${farmer.address}</textarea>
                </div>
                
                <div class="form-group">
                    <label>‡§®‡§Ø‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (‡§ñ‡§æ‡§≤‡•Ä ‡§õ‡•ã‡§°‡§º‡•á‡§Ç ‡§Ö‡§ó‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§¶‡§≤‡§®‡§æ ‡§π‡•à)</label>
                    <input type="password" id="editPassword">
                </div>
                
                <button class="btn btn-primary" onclick="saveEditedProfile('${username}')">üíæ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç</button>
                <button class="btn btn-secondary" onclick="loadSettingsContent()">‚ùå ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç</button>
            `;
            
            switchTab('settings');
        }

        // Save Edited Profile (Admin)
        function saveEditedProfile(oldUsername) {
            const name = document.getElementById('editName').value.trim();
            const username = document.getElementById('editUsername').value.trim();
            const village = document.getElementById('editVillage').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const address = document.getElementById('editAddress').value.trim();
            const password = document.getElementById('editPassword').value;
            
            // Check username availability
            if (username !== oldUsername) {
                if (farmers.some(f => f.username === username)) {
                    alert('‡§Ø‡§π ‡§Ø‡•Ç‡§ú‡§∞‡§®‡•á‡§Æ ‡§™‡§π‡§≤‡•á ‡§∏‡•á ‡§Æ‡•å‡§ú‡•Ç‡§¶ ‡§π‡•à');
                    return;
                }
            }
            
            const farmerIndex = farmers.findIndex(f => f.username === oldUsername);
            if (farmerIndex !== -1) {
                farmers[farmerIndex].name = name;
                farmers[farmerIndex].username = username;
                farmers[farmerIndex].village = village;
                farmers[farmerIndex].phone = phone;
                farmers[farmerIndex].address = address;
                
                if (password) {
                    farmers[farmerIndex].password = password;
                }
                
                localStorage.setItem('farmers', JSON.stringify(farmers));
                
                alert('‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à');
                loadSettingsContent();
                loadFarmerList();
            }
        }

        // Logout
        function handleLogout() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            currentUser = null;
            activeChatFarmer = null;
            localStorage.removeItem('currentUser');
            
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginScreen').classList.add('active');
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('messagesContainer').innerHTML = '';
        }
    </script>
</body>
</html>